{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/dwiya/.gemini/antigravity/scratch/toro-store-app/src/app/api/upload/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { writeFile, mkdir } from 'fs/promises';\r\nimport { existsSync } from 'fs';\r\nimport path from 'path';\r\nimport sharp from 'sharp';\r\n\r\n// Resolve the correct project root regardless of where `next` is invoked from.\r\n// When running `next dev toro-store-app` from scratch/, process.cwd() = scratch/\r\n// But the public folder is in scratch/toro-store-app/public/\r\nfunction getPublicDir(): string {\r\n  const subDirCandidate = path.join(process.cwd(), 'toro-store-app', 'public');\r\n  if (existsSync(subDirCandidate)) {\r\n    return subDirCandidate;\r\n  }\r\n  // Running from inside the project folder directly (e.g., `next dev`)\r\n  return path.join(process.cwd(), 'public');\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const formData = await req.formData();\r\n    const file = formData.get('file') as File | null;\r\n\r\n    if (!file || file.size === 0) {\r\n      return NextResponse.json({ success: false, error: 'File tidak ditemukan.' }, { status: 400 });\r\n    }\r\n\r\n    const allowed = ['image/jpeg', 'image/png', 'image/webp', 'image/gif', 'image/avif'];\r\n    if (!allowed.includes(file.type)) {\r\n      return NextResponse.json(\r\n        { success: false, error: 'Format tidak didukung. Gunakan JPG, PNG, atau WebP.' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (file.size > 10 * 1024 * 1024) {\r\n      return NextResponse.json(\r\n        { success: false, error: 'Ukuran file maksimal 10MB.' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const inputBuffer = Buffer.from(await file.arrayBuffer());\r\n\r\n    // Convert to WebP for smaller file size\r\n    const webpBuffer = await sharp(inputBuffer)\r\n      .resize(1200, 900, { fit: 'inside', withoutEnlargement: true })\r\n      .webp({ quality: 82 })\r\n      .toBuffer();\r\n\r\n    const filename = `pkg_${Date.now()}.webp`;\r\n    const uploadDir = path.join(getPublicDir(), 'uploads');\r\n    await mkdir(uploadDir, { recursive: true });\r\n    await writeFile(path.join(uploadDir, filename), webpBuffer);\r\n\r\n    return NextResponse.json({ success: true, url: `/uploads/${filename}` });\r\n  } catch (error) {\r\n    console.error('Upload failed:', error);\r\n    return NextResponse.json({ success: false, error: 'Upload gagal.' }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEA,+EAA+E;AAC/E,iFAAiF;AACjF,6DAA6D;AAC7D,SAAS;IACP,MAAM,kBAAkB,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,kBAAkB;IACnE,IAAI,IAAA,2GAAU,EAAC,kBAAkB;QAC/B,OAAO;IACT;IACA,qEAAqE;IACrE,OAAO,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI;AAClC;AAEO,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,WAAW,MAAM,IAAI,QAAQ;QACnC,MAAM,OAAO,SAAS,GAAG,CAAC;QAE1B,IAAI,CAAC,QAAQ,KAAK,IAAI,KAAK,GAAG;YAC5B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAAwB,GAAG;gBAAE,QAAQ;YAAI;QAC7F;QAEA,MAAM,UAAU;YAAC;YAAc;YAAa;YAAc;YAAa;SAAa;QACpF,IAAI,CAAC,QAAQ,QAAQ,CAAC,KAAK,IAAI,GAAG;YAChC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,OAAO;YAAsD,GAC/E;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,KAAK,IAAI,GAAG,KAAK,OAAO,MAAM;YAChC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,OAAO;YAA6B,GACtD;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,cAAc,OAAO,IAAI,CAAC,MAAM,KAAK,WAAW;QAEtD,wCAAwC;QACxC,MAAM,aAAa,MAAM,IAAA,0JAAK,EAAC,aAC5B,MAAM,CAAC,MAAM,KAAK;YAAE,KAAK;YAAU,oBAAoB;QAAK,GAC5D,IAAI,CAAC;YAAE,SAAS;QAAG,GACnB,QAAQ;QAEX,MAAM,WAAW,CAAC,IAAI,EAAE,KAAK,GAAG,GAAG,KAAK,CAAC;QACzC,MAAM,YAAY,4GAAI,CAAC,IAAI,CAAC,gBAAgB;QAC5C,MAAM,IAAA,8HAAK,EAAC,WAAW;YAAE,WAAW;QAAK;QACzC,MAAM,IAAA,kIAAS,EAAC,4GAAI,CAAC,IAAI,CAAC,WAAW,WAAW;QAEhD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,KAAK,CAAC,SAAS,EAAE,UAAU;QAAC;IACxE,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,kBAAkB;QAChC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO;QAAgB,GAAG;YAAE,QAAQ;QAAI;IACrF;AACF"}}]
}