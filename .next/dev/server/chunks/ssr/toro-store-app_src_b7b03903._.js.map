{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/dwiya/.gemini/antigravity/scratch/toro-store-app/src/actions/order.ts"],"sourcesContent":["'use server';\r\n\r\nimport { prisma } from '@/lib/prisma';\r\nimport { getStock } from './stock';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\nexport async function createOrder(data: {\r\n  packageType: 'BASIC' | 'PREMIUM' | 'SPECIAL';\r\n  itemName: string;\r\n  mlbbId: string;\r\n  serverId: string;\r\n  nickname?: string;\r\n  note?: string;\r\n  waNumber?: string;\r\n}) {\r\n  try {\r\n    // 1. Verify stock\r\n    const stock = await getStock();\r\n    \r\n    let isAvailable = false;\r\n    if (data.packageType === 'BASIC' && stock.basicStock > 0) isAvailable = true;\r\n    if (data.packageType === 'PREMIUM' && stock.premiumStock > 0) isAvailable = true;\r\n    if (data.packageType === 'SPECIAL' && stock.specialStock > 0) isAvailable = true;\r\n\r\n    if (!isAvailable) {\r\n      return { success: false, error: 'Stok Habis' };\r\n    }\r\n\r\n    // 2. Generate unique order code (TS-YYYY-RND4)\r\n    const year = new Date().getFullYear();\r\n    const rnd = Math.floor(1000 + Math.random() * 9000);\r\n    const orderCode = `TS-${year}-${rnd}`;\r\n\r\n    // 3. Save order to database\r\n    const order = await prisma.order.create({\r\n      data: {\r\n        orderCode,\r\n        packageType: data.packageType,\r\n        itemName: data.itemName,\r\n        mlbbId: data.mlbbId,\r\n        serverId: data.serverId,\r\n        nickname: data.nickname,\r\n        note: data.note,\r\n        waNumber: data.waNumber,\r\n        status: 'NEW',\r\n        events: {\r\n          create: {\r\n            eventType: 'ORDER_CREATED',\r\n            message: 'Order placed by user',\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    return { success: true, orderCode: order.orderCode };\r\n  } catch (error) {\r\n    console.error(\"Failed to create order:\", error);\r\n    return { success: false, error: 'Terjadi kesalahan sistem.' };\r\n  }\r\n}\r\n\r\nexport async function getAdminOrders() {\r\n  try {\r\n    const orders = await prisma.order.findMany({\r\n      orderBy: { createdAt: 'desc' },\r\n      take: 100\r\n    });\r\n    return orders;\r\n  } catch (error) {\r\n    console.error(\"Failed to fetch admin orders:\", error);\r\n    return [];\r\n  }\r\n}\r\n\r\nexport async function updateOrderStatus(orderId: string, newStatus: 'NEW' | 'CONFIRMED' | 'DONE' | 'CANCELED') {\r\n  try {\r\n    await prisma.order.update({\r\n      where: { id: orderId },\r\n      data: { status: newStatus },\r\n    });\r\n    \r\n    await prisma.orderEvent.create({\r\n      data: {\r\n        orderId: orderId,\r\n        eventType: 'STATUS_UPDATED',\r\n        message: `Status diubah menjadi ${newStatus}`,\r\n      }\r\n    });\r\n\r\n    revalidatePath('/admin');\r\n    revalidatePath('/admin/orders');\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error(\"Failed to update status:\", error);\r\n    return { success: false, error: 'Gagal mengupdate status' };\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MA6DsB,wBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA,kDAAA"}},
    {"offset": {"line": 18, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/dwiya/.gemini/antigravity/scratch/toro-store-app/src/actions/order.ts"],"sourcesContent":["'use server';\r\n\r\nimport { prisma } from '@/lib/prisma';\r\nimport { getStock } from './stock';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\nexport async function createOrder(data: {\r\n  packageType: 'BASIC' | 'PREMIUM' | 'SPECIAL';\r\n  itemName: string;\r\n  mlbbId: string;\r\n  serverId: string;\r\n  nickname?: string;\r\n  note?: string;\r\n  waNumber?: string;\r\n}) {\r\n  try {\r\n    // 1. Verify stock\r\n    const stock = await getStock();\r\n    \r\n    let isAvailable = false;\r\n    if (data.packageType === 'BASIC' && stock.basicStock > 0) isAvailable = true;\r\n    if (data.packageType === 'PREMIUM' && stock.premiumStock > 0) isAvailable = true;\r\n    if (data.packageType === 'SPECIAL' && stock.specialStock > 0) isAvailable = true;\r\n\r\n    if (!isAvailable) {\r\n      return { success: false, error: 'Stok Habis' };\r\n    }\r\n\r\n    // 2. Generate unique order code (TS-YYYY-RND4)\r\n    const year = new Date().getFullYear();\r\n    const rnd = Math.floor(1000 + Math.random() * 9000);\r\n    const orderCode = `TS-${year}-${rnd}`;\r\n\r\n    // 3. Save order to database\r\n    const order = await prisma.order.create({\r\n      data: {\r\n        orderCode,\r\n        packageType: data.packageType,\r\n        itemName: data.itemName,\r\n        mlbbId: data.mlbbId,\r\n        serverId: data.serverId,\r\n        nickname: data.nickname,\r\n        note: data.note,\r\n        waNumber: data.waNumber,\r\n        status: 'NEW',\r\n        events: {\r\n          create: {\r\n            eventType: 'ORDER_CREATED',\r\n            message: 'Order placed by user',\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    return { success: true, orderCode: order.orderCode };\r\n  } catch (error) {\r\n    console.error(\"Failed to create order:\", error);\r\n    return { success: false, error: 'Terjadi kesalahan sistem.' };\r\n  }\r\n}\r\n\r\nexport async function getAdminOrders() {\r\n  try {\r\n    const orders = await prisma.order.findMany({\r\n      orderBy: { createdAt: 'desc' },\r\n      take: 100\r\n    });\r\n    return orders;\r\n  } catch (error) {\r\n    console.error(\"Failed to fetch admin orders:\", error);\r\n    return [];\r\n  }\r\n}\r\n\r\nexport async function updateOrderStatus(orderId: string, newStatus: 'NEW' | 'CONFIRMED' | 'DONE' | 'CANCELED') {\r\n  try {\r\n    await prisma.order.update({\r\n      where: { id: orderId },\r\n      data: { status: newStatus },\r\n    });\r\n    \r\n    await prisma.orderEvent.create({\r\n      data: {\r\n        orderId: orderId,\r\n        eventType: 'STATUS_UPDATED',\r\n        message: `Status diubah menjadi ${newStatus}`,\r\n      }\r\n    });\r\n\r\n    revalidatePath('/admin');\r\n    revalidatePath('/admin/orders');\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error(\"Failed to update status:\", error);\r\n    return { success: false, error: 'Gagal mengupdate status' };\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MA0EsB,wBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA,qDAAA"}},
    {"offset": {"line": 32, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/dwiya/.gemini/antigravity/scratch/toro-store-app/src/app/admin/orders/page.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { getAdminOrders, updateOrderStatus } from '@/actions/order';\r\n\r\ntype Order = {\r\n  id: string;\r\n  orderCode: string;\r\n  packageType: string;\r\n  itemName: string;\r\n  mlbbId: string;\r\n  serverId: string;\r\n  nickname: string | null;\r\n  waNumber: string | null;\r\n  status: 'NEW' | 'CONFIRMED' | 'DONE' | 'CANCELED';\r\n  createdAt: Date;\r\n};\r\n\r\nexport default function AdminOrdersPage() {\r\n  const [orders, setOrders] = useState<Order[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [updatingId, setUpdatingId] = useState<string | null>(null);\r\n\r\n  useEffect(() => {\r\n    fetchOrders();\r\n  }, []);\r\n\r\n  const fetchOrders = async () => {\r\n    setIsLoading(true);\r\n    const data = await getAdminOrders();\r\n    // @ts-ignore - Date serialization issue from Server Action in dev\r\n    setOrders(data);\r\n    setIsLoading(false);\r\n  };\r\n\r\n  const handleStatusChange = async (id: string, newStatus: 'NEW' | 'CONFIRMED' | 'DONE' | 'CANCELED') => {\r\n    setUpdatingId(id);\r\n    const res = await updateOrderStatus(id, newStatus);\r\n    if (res.success) {\r\n      await fetchOrders();\r\n    } else {\r\n      alert(res.error);\r\n    }\r\n    setUpdatingId(null);\r\n  };\r\n\r\n  const copyTemplate = (order: Order) => {\r\n    const text = `Halo kak ${order.nickname || ''},\\n\\nOrder #${order.orderCode} (Paket ${order.packageType}) untuk skin/event ${order.itemName} sudah kami proses ya.\\n\\nTerima kasih sudah percayakan ke Toro Store!`;\r\n    navigator.clipboard.writeText(text);\r\n    alert('Template balasan disalin!');\r\n  };\r\n\r\n  if (isLoading) {\r\n    return <div className=\"animate-pulse\">Memuat data order...</div>;\r\n  }\r\n\r\n  return (\r\n    <div className=\"animate-in slide-in-from-bottom-4 duration-500\">\r\n      <div className=\"flex justify-between items-end mb-8\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold mb-2\">Data Order</h1>\r\n          <p className=\"text-neutral-400\">Daftar pesanan masuk dari pelanggan.</p>\r\n        </div>\r\n        <button onClick={fetchOrders} className=\"bg-neutral-800 hover:bg-neutral-700 px-4 py-2 rounded-md transition-colors text-sm\">\r\n          <i className=\"fa-solid fa-rotate-right mr-2\"></i>Refresh\r\n        </button>\r\n      </div>\r\n\r\n      <div className=\"bg-neutral-900 border border-neutral-800 rounded-lg overflow-hidden shadow-xl\">\r\n        <div className=\"overflow-x-auto\">\r\n          <table className=\"w-full text-left border-collapse min-w-[1000px]\">\r\n            <thead>\r\n              <tr className=\"bg-neutral-950/50 border-b border-neutral-800\">\r\n                <th className=\"p-4 text-sm font-medium text-neutral-400\">Order ID & Waktu</th>\r\n                <th className=\"p-4 text-sm font-medium text-neutral-400\">Detail Game</th>\r\n                <th className=\"p-4 text-sm font-medium text-neutral-400\">Pesanan</th>\r\n                <th className=\"p-4 text-sm font-medium text-neutral-400\">Status</th>\r\n                <th className=\"p-4 text-sm font-medium text-neutral-400 text-right\">Aksi</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody className=\"divide-y divide-neutral-800\">\r\n              {orders.map((order) => (\r\n                <tr key={order.id} className=\"hover:bg-neutral-800/30 transition-colors\">\r\n                  <td className=\"p-4 align-top\">\r\n                    <div className=\"font-mono text-blue-400 font-bold\">{order.orderCode}</div>\r\n                    <div className=\"text-xs text-neutral-500 mt-1\">\r\n                      {new Date(order.createdAt).toLocaleString('id-ID')}\r\n                    </div>\r\n                  </td>\r\n                  <td className=\"p-4 align-top\">\r\n                    <div className=\"text-sm\">\r\n                      <span className=\"text-neutral-400\">ID:</span> {order.mlbbId} ({order.serverId})\r\n                    </div>\r\n                    {order.nickname && (\r\n                      <div className=\"text-sm mt-1\">\r\n                        <span className=\"text-neutral-400\">Nick:</span> {order.nickname}\r\n                      </div>\r\n                    )}\r\n                  </td>\r\n                  <td className=\"p-4 align-top\">\r\n                    <div className=\"text-sm font-bold text-amber-500\">{order.packageType}</div>\r\n                    <div className=\"text-sm text-neutral-300 mt-1\">{order.itemName}</div>\r\n                  </td>\r\n                  <td className=\"p-4 align-top\">\r\n                    <select\r\n                      value={order.status}\r\n                      disabled={updatingId === order.id}\r\n                      onChange={(e) => handleStatusChange(order.id, e.target.value as any)}\r\n                      className={`text-sm font-bold rounded px-3 py-1.5 border appearance-none cursor-pointer outline-none transition-colors\r\n                        ${order.status === 'NEW' ? 'bg-blue-500/10 text-blue-400 border-blue-500/30' : ''}\r\n                        ${order.status === 'CONFIRMED' ? 'bg-amber-500/10 text-amber-400 border-amber-500/30' : ''}\r\n                        ${order.status === 'DONE' ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/30' : ''}\r\n                        ${order.status === 'CANCELED' ? 'bg-red-500/10 text-red-500 border-red-500/30' : ''}\r\n                        ${updatingId === order.id ? 'opacity-50 cursor-wait' : ''}\r\n                      `}\r\n                    >\r\n                      <option value=\"NEW\" className=\"bg-neutral-900 text-white\">NEW</option>\r\n                      <option value=\"CONFIRMED\" className=\"bg-neutral-900 text-white\">CONFIRMED</option>\r\n                      <option value=\"DONE\" className=\"bg-neutral-900 text-white\">DONE</option>\r\n                      <option value=\"CANCELED\" className=\"bg-neutral-900 text-white\">CANCELED</option>\r\n                    </select>\r\n                  </td>\r\n                  <td className=\"p-4 align-top text-right space-x-2\">\r\n                    <button \r\n                      onClick={() => copyTemplate(order)}\r\n                      className=\"bg-neutral-800 hover:bg-neutral-700 text-neutral-300 px-3 py-1.5 rounded border border-neutral-700 transition\"\r\n                      title=\"Copy template balasan WA\"\r\n                    >\r\n                      <i className=\"fa-regular fa-copy\"></i>\r\n                    </button>\r\n                    {order.waNumber && (\r\n                      <a \r\n                        href={`https://wa.me/${order.waNumber}`}\r\n                        target=\"_blank\"\r\n                        className=\"inline-block bg-[#25d366]/20 hover:bg-[#25d366]/30 text-[#25d366] px-3 py-1.5 rounded border border-[#25d366]/30 transition\"\r\n                      >\r\n                        <i className=\"fa-brands fa-whatsapp\"></i>\r\n                      </a>\r\n                    )}\r\n                  </td>\r\n                </tr>\r\n              ))}\r\n\r\n              {orders.length === 0 && (\r\n                <tr>\r\n                  <td colSpan={5} className=\"p-12 text-center\">\r\n                    <i className=\"fa-solid fa-inbox text-4xl text-neutral-700 mb-4 block\"></i>\r\n                    <p className=\"text-neutral-500\">Belum ada pesanan masuk saat ini.</p>\r\n                  </td>\r\n                </tr>\r\n              )}\r\n            </tbody>\r\n          </table>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAAA;AAHA;;;;AAkBe,SAAS;IACtB,MAAM,CAAC,QAAQ,UAAU,GAAG,IAAA,iNAAQ,EAAU,EAAE;IAChD,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,iNAAQ,EAAC;IAC3C,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,iNAAQ,EAAgB;IAE5D,IAAA,kNAAS,EAAC;QACR;IACF,GAAG,EAAE;IAEL,MAAM,cAAc;QAClB,aAAa;QACb,MAAM,OAAO,MAAM,IAAA,gMAAc;QACjC,kEAAkE;QAClE,UAAU;QACV,aAAa;IACf;IAEA,MAAM,qBAAqB,OAAO,IAAY;QAC5C,cAAc;QACd,MAAM,MAAM,MAAM,IAAA,mMAAiB,EAAC,IAAI;QACxC,IAAI,IAAI,OAAO,EAAE;YACf,MAAM;QACR,OAAO;YACL,MAAM,IAAI,KAAK;QACjB;QACA,cAAc;IAChB;IAEA,MAAM,eAAe,CAAC;QACpB,MAAM,OAAO,CAAC,SAAS,EAAE,MAAM,QAAQ,IAAI,GAAG,YAAY,EAAE,MAAM,SAAS,CAAC,QAAQ,EAAE,MAAM,WAAW,CAAC,mBAAmB,EAAE,MAAM,QAAQ,CAAC,sEAAsE,CAAC;QACnN,UAAU,SAAS,CAAC,SAAS,CAAC;QAC9B,MAAM;IACR;IAEA,IAAI,WAAW;QACb,qBAAO,8OAAC;YAAI,WAAU;sBAAgB;;;;;;IACxC;IAEA,qBACE,8OAAC;QAAI,WAAU;;0BACb,8OAAC;gBAAI,WAAU;;kCACb,8OAAC;;0CACC,8OAAC;gCAAG,WAAU;0CAA0B;;;;;;0CACxC,8OAAC;gCAAE,WAAU;0CAAmB;;;;;;;;;;;;kCAElC,8OAAC;wBAAO,SAAS;wBAAa,WAAU;;0CACtC,8OAAC;gCAAE,WAAU;;;;;;4BAAoC;;;;;;;;;;;;;0BAIrD,8OAAC;gBAAI,WAAU;0BACb,cAAA,8OAAC;oBAAI,WAAU;8BACb,cAAA,8OAAC;wBAAM,WAAU;;0CACf,8OAAC;0CACC,cAAA,8OAAC;oCAAG,WAAU;;sDACZ,8OAAC;4CAAG,WAAU;sDAA2C;;;;;;sDACzD,8OAAC;4CAAG,WAAU;sDAA2C;;;;;;sDACzD,8OAAC;4CAAG,WAAU;sDAA2C;;;;;;sDACzD,8OAAC;4CAAG,WAAU;sDAA2C;;;;;;sDACzD,8OAAC;4CAAG,WAAU;sDAAsD;;;;;;;;;;;;;;;;;0CAGxE,8OAAC;gCAAM,WAAU;;oCACd,OAAO,GAAG,CAAC,CAAC,sBACX,8OAAC;4CAAkB,WAAU;;8DAC3B,8OAAC;oDAAG,WAAU;;sEACZ,8OAAC;4DAAI,WAAU;sEAAqC,MAAM,SAAS;;;;;;sEACnE,8OAAC;4DAAI,WAAU;sEACZ,IAAI,KAAK,MAAM,SAAS,EAAE,cAAc,CAAC;;;;;;;;;;;;8DAG9C,8OAAC;oDAAG,WAAU;;sEACZ,8OAAC;4DAAI,WAAU;;8EACb,8OAAC;oEAAK,WAAU;8EAAmB;;;;;;gEAAU;gEAAE,MAAM,MAAM;gEAAC;gEAAG,MAAM,QAAQ;gEAAC;;;;;;;wDAE/E,MAAM,QAAQ,kBACb,8OAAC;4DAAI,WAAU;;8EACb,8OAAC;oEAAK,WAAU;8EAAmB;;;;;;gEAAY;gEAAE,MAAM,QAAQ;;;;;;;;;;;;;8DAIrE,8OAAC;oDAAG,WAAU;;sEACZ,8OAAC;4DAAI,WAAU;sEAAoC,MAAM,WAAW;;;;;;sEACpE,8OAAC;4DAAI,WAAU;sEAAiC,MAAM,QAAQ;;;;;;;;;;;;8DAEhE,8OAAC;oDAAG,WAAU;8DACZ,cAAA,8OAAC;wDACC,OAAO,MAAM,MAAM;wDACnB,UAAU,eAAe,MAAM,EAAE;wDACjC,UAAU,CAAC,IAAM,mBAAmB,MAAM,EAAE,EAAE,EAAE,MAAM,CAAC,KAAK;wDAC5D,WAAW,CAAC;wBACV,EAAE,MAAM,MAAM,KAAK,QAAQ,oDAAoD,GAAG;wBAClF,EAAE,MAAM,MAAM,KAAK,cAAc,uDAAuD,GAAG;wBAC3F,EAAE,MAAM,MAAM,KAAK,SAAS,6DAA6D,GAAG;wBAC5F,EAAE,MAAM,MAAM,KAAK,aAAa,iDAAiD,GAAG;wBACpF,EAAE,eAAe,MAAM,EAAE,GAAG,2BAA2B,GAAG;sBAC5D,CAAC;;0EAED,8OAAC;gEAAO,OAAM;gEAAM,WAAU;0EAA4B;;;;;;0EAC1D,8OAAC;gEAAO,OAAM;gEAAY,WAAU;0EAA4B;;;;;;0EAChE,8OAAC;gEAAO,OAAM;gEAAO,WAAU;0EAA4B;;;;;;0EAC3D,8OAAC;gEAAO,OAAM;gEAAW,WAAU;0EAA4B;;;;;;;;;;;;;;;;;8DAGnE,8OAAC;oDAAG,WAAU;;sEACZ,8OAAC;4DACC,SAAS,IAAM,aAAa;4DAC5B,WAAU;4DACV,OAAM;sEAEN,cAAA,8OAAC;gEAAE,WAAU;;;;;;;;;;;wDAEd,MAAM,QAAQ,kBACb,8OAAC;4DACC,MAAM,CAAC,cAAc,EAAE,MAAM,QAAQ,EAAE;4DACvC,QAAO;4DACP,WAAU;sEAEV,cAAA,8OAAC;gEAAE,WAAU;;;;;;;;;;;;;;;;;;2CAtDZ,MAAM,EAAE;;;;;oCA6DlB,OAAO,MAAM,KAAK,mBACjB,8OAAC;kDACC,cAAA,8OAAC;4CAAG,SAAS;4CAAG,WAAU;;8DACxB,8OAAC;oDAAE,WAAU;;;;;;8DACb,8OAAC;oDAAE,WAAU;8DAAmB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAUpD"}}]
}